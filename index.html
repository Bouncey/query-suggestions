<!DOCTYPE html>
<html>
  <head>
    <title>Algolia Search for Popular Searches test</title>

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <style>
*, *:after, *:before {
  font-family: Open Sans, sans-serif;
  box-sizing: border-box;
}

*:before {
  font-family: FontAwesome, Open Sans, sans-serif;
}

h1 {
  text-align: center;
}

.algolia-autocomplete {
  width: 100%;
}

#search_input {
  width: 100%;
  padding: 8px 16px;
}

.aa-dropdown-menu {
  position: relative;
  width: 100%;
  margin-top: 16px;
  background: #ffffff;
  border: 2px solid #e8e8e8;
}

.aa-dropdown-menu:after, .aa-dropdown-menu:before {
  bottom: 100%;
  right: 20px;
  border: solid transparent;
  content: " ";
  height: 0;
  width: 0;
  position: absolute;
  pointer-events: none;
}

.aa-dropdown-menu:after {
  border-color: rgba(255, 255, 255, 0);
  border-bottom-color: #ffffff;
  border-width: 12px;
  margin-left: -12px;
  right: 22px;
}

.aa-dropdown-menu:before {
  border-color: rgba(232, 232, 232, 0);
  border-bottom-color: #e8e8e8;
  border-width: 14px;
  margin-left: -14px;
}

.aa-suggestion {
  padding: 8px 8px;
  border-bottom: 1px solid #ebebeb;
  cursor: pointer;
}

.aa-suggestion.aa-cursor {
  background: #f8f8f8;
}

.highlight {
  font-weight: bold;
}

.aa-footer {
  font-size: 0.95em;
}
    </style>
  </head>
  <body>
    <select id="index_selector">
      <option value="hackernews" selected>HackerNews</option>
      <option value="instant_search">Instant Search demo</option>
    </select>

    <h1 id="title">Search in HackerNews popular searches</h1>
    <input id="search_input" type="text" autocomplete="off" placeholder="Search for HackerNews topics" autofocus="autofocus" />

    <script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
    <script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
    <script>
      function escapeHtml (text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function escapeRegExp (str) {
        return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
      }

      var QUERIES_AMOUNT = 8;

      var RECENT_SEARCHES = {
        hackernews: [
          'apple',
          'iphone 7',
          'facebook',
          'amazon'
        ],
        instant_search: [
          'iphone 7',
          'iphone 6s',
          'iphone 6',
          'iphone'
        ]
      };

      var AVAILABLE = {
        hackernews: {
          title: 'HackerNews',
          placeholder: 'Search for HackerNews topics',
          url: 'https://hn.algolia.com/?q=',
          index: algoliasearch('UJ5WYC0L7X', '08240194d5ef567a9f14e0f066bace0c').initIndex('Item_production'),
          keys: {
            main: 'title',
            secondary: 'story_text',
            img: ''
          },
          parameters: {
            tagFilters: ['story']
          }
        },
        instant_search: {
          title: 'Instant Search demo',
          placeholder: 'Search for products suggestions',
          url: 'https://demos.algolia.com/instant-search-demo/?q=',
          index: algoliasearch('latency', '6be0576ff61c053d5f9a3225e2a90f76').initIndex('instant_search'),
          keys: {
            main: 'name',
            secondary: 'description',
            img: 'image'
          },
          parameters: {}
        }
      };

      var $index_selector = document.getElementById('index_selector');
      var $title = document.getElementById('title');
      var $search_input = document.getElementById('search_input');

      var index = $index_selector.value;
      var client = algoliasearch('OMDED4ZQES', '24c5f81bb301609f7dced52863634ec6')
      var aa = null;

      function createAutocomplete () {
        var query = null;
        var popularIndex = client.initIndex(index + '_popular_searches');
        var dataIndex = AVAILABLE[index].index;
        var dataKeys = AVAILABLE[index].keys;
        var dataParameters = AVAILABLE[index].parameters;
        var recentSearches = RECENT_SEARCHES[index];

        function getRecents (q) {
          return recentSearches.filter(function(search) {
            return search.indexOf(q) !== -1;
          }).slice(0, QUERIES_AMOUNT);
        }

        function addRecent (q) {
          q = (q || '').toLowerCase();
          if (!q) return;
          var firstRecent = recentSearches[0];
          if (firstRecent.indexOf(q) !== -1) return;
          if (q.indexOf(firstRecent) !== -1) {
            recentSearches[0] = q;
            return;
          }
          recentSearches.unshift(q);
        }

        function buildEntry (suggestionType, content) {
          var icon = '';
          if (suggestionType === 'recent') icon = 'clock-o';
          if (suggestionType === 'popular') icon = 'search';
          return '' +
            '<span class="suggestion-left">' +
            '  <i class="fa fa-' + icon + '"></i>' +
            '</span>' +
            '<span class="suggestion-right">' +
            '  <span class="suggested-query suggested-' + suggestionType + '">' +
            '    ' + content +
            '  </span>' +
            '</span>';
        }

        $title.innerText = AVAILABLE[index].title + ' popular searches';
        $search_input.placeholder = AVAILABLE[index].placeholder;

        aa = autocomplete('#search_input', { hint: false, openOnFocus: true, minLength: 0 }, [
          {
            source: function (q, cb) {

              var res = [];
              var recents = getRecents(q);

              var popularPromise = popularIndex.search(q, {
                hitsPerPage: QUERIES_AMOUNT,
                highlightPreTag: '<span class="highlight">',
                highlightPostTag: '</span>'
              }).then(function (content) {
                return content.hits.filter(function (h) {
                  return recents.indexOf(h.query) === -1;
                }).map(function (h) {
                  return buildEntry('popular', h._highlightResult.query.value);
                }).slice(0, QUERIES_AMOUNT - recents.length);
              }).catch(function (error) {
                console.error(error);
              });

              var dataPromise = dataIndex.search(q, Object.assign({}, dataParameters, {
                hitsPerPage: 20,
                highlightPreTag: '<span class="highlight">',
                highlightPostTag: '</span>',
                attributesToRetrieve: [dataKeys.img],
                attributesToHighlight: [dataKeys.main],
                attributesToSnippet: [dataKeys.secondary + ':20']
              })).then(function (content) {
                return content.hits.map(function (h) {
                  return '' +
                    '<span class="suggestion-left">' +
                    '</span>' +
                    '<span class="suggestion-right">' +
                    '  ' + ((!h._highlightResult || !h._highlightResult[dataKeys.main]) ? ('No ' + dataKeys.main) : h._highlightResult[dataKeys.main].value) +
                    '</span>'
                    ;
                });
              });

              res = res.concat(recents.map(function (search) {
                var highlighted = search.replace(new RegExp(escapeRegExp(q), 'g'), '<span class="highlight">$&</span>');
                return buildEntry('recent', highlighted);
              }));
              Promise.all([popularPromise, dataPromise]).then(function (data) {
                data.forEach(function (arr) {
                  res = res.concat(arr);
                });
                cb(res);
              });
            },
            displayKey: 'query',
            templates: {
              suggestion: function(suggestion) {
                return suggestion;
              },
              footer: function(opts) {
                query = opts.query;
                return '<div class="aa-suggestion aa-footer">Search for results matching "' + query + '"</div>'
              }
            }
          }
        ]).on('autocomplete:selected', function(event, suggestion, dataset) {
          if (suggestion === undefined) {
            suggestion = {
              query: query
            };
          }
          window.location.href = AVAILABLE[index].url + encodeURIComponent(suggestion.query);
        });
        $search_input.focus();
        $search_input.addEventListener('blur', function () {
          addRecent($search_input.value);
        });
      }
      createAutocomplete();

      $index_selector.addEventListener('change', function () {
        index = $index_selector.value;
        aa.autocomplete.destroy();
        createAutocomplete();
      });
    </script>
  </body>
</html>
